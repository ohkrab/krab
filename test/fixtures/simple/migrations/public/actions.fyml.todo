---
apiVersion: actions/v1
kind: Action
metadata:
  name: create_database
  description: Create a new database with quoted parameters
spec:
  args:
    - name: database_name
      description: The name of the database to create
      type: string
    - name: database_owner
      description: The owner of the database
      type: string
      log: false
  run:
    transaction: false
    steps:
      - sql: |
          CREATE DATABASE $({ .args.database_name | quote_ident }) OWNER $({ .args.database_owner | quote_ident });
---
apiVersion: actions/v1
kind: Action
metadata:
  name: insert_tenant
  description: Create a new tenant for the given database
spec:
  args:
    - name: tenant
      description: The name of the tenant to create
      type: string
  run:
    steps:
      - sql: |
          CREATE SCHEMA $({ .args.tenant | quote_ident });
      - sql: |
          INSERT INTO tenants (name) VALUES ($({ .args.tenant | quote }));
---
apiVersion: actions/v1
kind: Action
metadata:
  name: create_tenant
  description: Create a new tenant for the given database
spec:
  args:
    - name: tenant
      description: The name of the tenant to create
      type: string
  run:
    transaction: false
    steps:
      - sql: |
          CREATE SCHEMA $({ .args.tenant | quote_ident });
          INSERT INTO tenants (name) VALUES ($({ .args.tenant | quote }));
      - invoke:
          resource:
            kind: Action
            name: insert_tenant
          args:
            tenant: $({ .args.tenant }) # pass it raw, migration set will quote it
      - invoke:
          resource:
            kind: MigrationSet
            name: public
          command: up
          args:
            schema: $({ .args.tenant }) # pass it raw, migration set will quote it
---
apiVersion: events/v1
kind: EventHook
metadata:
  name: after_each_migration_set
spec:
  on:
    event: "before.migration_set.up"
    filter:
      migration_set:
        success: true
    
  run:
    - http:
        url: ${{ env.HOOK_URL }}
        method: POST
        content_type: application/json
        body: |
          {
            "migration_set": "$migration_set.name",
            "migration": "$migration.name"
          }
        # or json builder:
        json:
          migration_set: $migration_set.name
          ok: true