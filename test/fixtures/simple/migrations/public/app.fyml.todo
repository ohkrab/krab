apiVersion: app/v1
kind: Package
spec:
  name: module/animals
  imports:
    - "fauna/core"
---
kind: Type
spec:
  type: "struct"
  struct:
    name: Animal
    attrs:
      - name: "id"
        type: "int"
      - name: "name"
        type: "string"
---
kind: Type
spec:
  type: "enum"
  values:
    - "KINGDOM_SEA"
    - "KINGDOM_FOREST"
---
kind: Query
spec:
  name: ListAnimals
  description: "List all animals"
  args:
    - name: "limit"
      type: "int"
      default: "10"
    - name: "offset"
      type: "int"
      default: "10"
  returns:
    type: "array"
    array:
      type: "struct"
      struct:
        ref: "Animal"
  sql: "SELECT * FROM animals ORDER BY name;"
---
kind: Query
spec:
  name: AnimalsReport
  description: "Get a report of all animals"
  returns:
    type: "array"
    array:
      type: "struct"
      struct:
        ref: "Animal"
  file: "animals_report.sql.tpl"
---
kind: Query
spec:
  name: CreateAnimal
  args:
    - name: "name"
      type: "string"
  returns:
    type: "struct"
    struct:
      ref: "Animal"
  sql: "INSERT INTO animals (name) VALUES ({{ .name | quote }}) RETURNING *;"
---
name: FindAnimalById
native: true
args:
  - name: "id"
    type: "int"
returns:
  type: "struct"
  struct:
    ref: "Animal"
  sql: "SELECT * FROM animals WHERE id = $1 LIMIT 1;"
---
kind: Query
spec:
  name: CreateAnimals
  args:
    - name: "animals"
      type: "array"
      array:
        type: "struct"
        struct:
          ref: "Animal"
  sql: |
    {{ $animals := len(.animals) }}
    {{ $index := 0 }}
    INSERT INTO animals (name) VALUES (
      {{ range .animals }}
        {{ $index += 1 -}}
        {{ .name | quote }}{{ if ne $index $animals }},{{ end -}}
      {{ end }}
    ) RETURNING *;
---
kind: Query
spec:
  name: UpdateAnimal
  args:
    - name: "id"
      type: "int"
    - name: "name"
      type: "string"
  returns:
    type: "array"
    array:
      type: "struct"
      struct:
        attrs:
          - name: "id"
            type: "int"
  sql: "UPDATE animals SET name = {{ .name | quote }} WHERE id = {{ .id | quote }} RETURNING id;"
---
kind: Query
spec:
  name: DeleteAnimal
  args:
    - name: "id"
      type: "int"
  sql: "DELETE FROM animals WHERE id = {{ .id | quote }};"
---
kind: Query
spec:
  name: TruncateAnimals
  sql: "TRUNCATE TABLE animals RESTART IDENTITY;"
